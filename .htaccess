# Tailoring Management System - Universal Configuration
# Works on any server and deployment structure

# Enable URL rewriting
RewriteEngine On

# =====================================================
# Remove .php extension from URLs
# =====================================================

# External redirect from /page.php to /page (301 permanent redirect)
# This hides the .php extension from users and search engines
# IMPORTANT: Only redirect if THE_REQUEST actually contains .php (original browser request)
# Capture the full path including subdirectory from THE_REQUEST
RewriteCond %{THE_REQUEST} ^[A-Z]+\s/+(.+?)\.php(\?[^\s]*)?\s [NC]
RewriteCond %{REQUEST_URI} !^/.*ajax/ [NC]
RewriteCond %{REQUEST_URI} !^/.*admin/ajax/ [NC]
RewriteCond %{REQUEST_FILENAME} -f
# Use REQUEST_URI to get the full path, then redirect to same path without .php
RewriteCond %{REQUEST_URI} ^/(.+?)\.php(\?.*)?$ [NC]
RewriteRule ^ /%1%2 [R=301,L,QSA]

# Internal rewrite: Add .php extension if file exists
# This handles URLs without .php extension (clean URLs)
RewriteCond %{REQUEST_FILENAME} !-f
RewriteCond %{REQUEST_FILENAME} !-d
RewriteCond %{REQUEST_URI} !^/.*ajax/ [NC]
RewriteCond %{REQUEST_URI} !^/.*admin/ajax/ [NC]
RewriteCond %{REQUEST_URI} !\.(jpg|jpeg|png|gif|css|js|ico|svg|woff|woff2|ttf|eot|pdf|zip|sql|log|php|html)$ [NC]
# Check if .php file exists - use REQUEST_FILENAME which preserves full path
RewriteCond %{REQUEST_FILENAME}.php -f
# Internal rewrite - add .php extension using REQUEST_URI to preserve full path
RewriteCond %{REQUEST_URI} ^/(.+)$ [NC]
RewriteRule ^ /%1.php [L]

# Get the base directory dynamically
RewriteCond %{REQUEST_URI}::$1 ^(.*?/)(.*)::\2$
RewriteRule ^(.*)$ - [E=BASE:%1]

# Redirect old authentication URLs to admin folder (only if not already in admin)
RewriteCond %{REQUEST_FILENAME} !-f
RewriteCond %{REQUEST_FILENAME} !-d
RewriteCond %{REQUEST_URI} !^/.*admin/
RewriteRule ^login\.php$ admin/login.php [R=301,L]

RewriteCond %{REQUEST_FILENAME} !-f
RewriteCond %{REQUEST_FILENAME} !-d
RewriteCond %{REQUEST_URI} !^/.*admin/
RewriteRule ^register\.php$ admin/register.php [R=301,L]

RewriteCond %{REQUEST_FILENAME} !-f
RewriteCond %{REQUEST_FILENAME} !-d
RewriteCond %{REQUEST_URI} !^/.*admin/
RewriteRule ^logout\.php$ admin/logout.php [R=301,L]

RewriteCond %{REQUEST_FILENAME} !-f
RewriteCond %{REQUEST_FILENAME} !-d
RewriteCond %{REQUEST_URI} !^/.*admin/
RewriteRule ^settings\.php$ admin/settings.php [R=301,L]

# Redirect admin utility files to admin folder (only if not already in admin)
RewriteCond %{REQUEST_FILENAME} !-f
RewriteCond %{REQUEST_FILENAME} !-d
RewriteCond %{REQUEST_URI} !^/.*admin/
RewriteRule ^setup_measurement_charts\.php$ admin/setup_measurement_charts.php [R=301,L]

RewriteCond %{REQUEST_FILENAME} !-f
RewriteCond %{REQUEST_FILENAME} !-d
RewriteCond %{REQUEST_URI} !^/.*admin/
RewriteRule ^setup_multi_tenant\.php$ admin/setup_multi_tenant.php [R=301,L]

RewriteCond %{REQUEST_FILENAME} !-f
RewriteCond %{REQUEST_FILENAME} !-d
RewriteCond %{REQUEST_URI} !^/.*admin/
RewriteRule ^auto_fix_user\.php$ admin/auto_fix_user.php [R=301,L]

RewriteCond %{REQUEST_FILENAME} !-f
RewriteCond %{REQUEST_FILENAME} !-d
RewriteCond %{REQUEST_URI} !^/.*admin/
RewriteRule ^fix_measurement_charts\.php$ admin/fix_measurement_charts.php [R=301,L]

RewriteCond %{REQUEST_FILENAME} !-f
RewriteCond %{REQUEST_FILENAME} !-d
RewriteCond %{REQUEST_URI} !^/.*admin/
RewriteRule ^fix_user_session\.php$ admin/fix_user_session.php [R=301,L]

RewriteCond %{REQUEST_FILENAME} !-f
RewriteCond %{REQUEST_FILENAME} !-d
RewriteCond %{REQUEST_URI} !^/.*admin/
RewriteRule ^force_reset_password\.php$ admin/force_reset_password.php [R=301,L]

RewriteCond %{REQUEST_FILENAME} !-f
RewriteCond %{REQUEST_FILENAME} !-d
RewriteCond %{REQUEST_URI} !^/.*admin/
RewriteRule ^check_measurement_charts\.php$ admin/check_measurement_charts.php [R=301,L]

RewriteCond %{REQUEST_FILENAME} !-f
RewriteCond %{REQUEST_FILENAME} !-d
RewriteCond %{REQUEST_URI} !^/.*admin/
RewriteRule ^test_login\.php$ admin/test_login.php [R=301,L]

RewriteCond %{REQUEST_FILENAME} !-f
RewriteCond %{REQUEST_FILENAME} !-d
RewriteCond %{REQUEST_URI} !^/.*admin/
RewriteRule ^info\.php$ admin/info.php [R=301,L]

# Handle 404 errors
ErrorDocument 404 /404.php

# Sitemap - serve sitemap.xml from sitemap.php
RewriteCond %{REQUEST_FILENAME} !-f
RewriteCond %{REQUEST_FILENAME} !-d
RewriteRule ^sitemap\.xml$ sitemap.php [L]

# Protect sensitive files (WAMP compatible syntax)
<Files "*.sql">
    Require all denied
</Files>

<Files "*.log">
    Require all denied
</Files>

<Files "config.php">
    Require all denied
</Files>

<Files "database.php">
    Require all denied
</Files>

# Protect installation file after setup
<Files "install.php">
    Require all denied
</Files>

# Prevent access to hidden files
<FilesMatch "^\.">
    Require all denied
</FilesMatch>

# Prevent access to backup files
<FilesMatch "\.(bak|backup|old|tmp)$">
    Require all denied
</FilesMatch>
